<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Huge File Reader</title>
</head>
<body style="margin:0;font-family:sans-serif">
    <div id="progress">Drop a file...</div>
    <script>

(function() {

var progress = document.getElementById('progress')

progress.style.background = '#396'
progress.style.color = '#fff'
progress.style.fontWeight = 'bold'
progress.style.padding = '5px'
progress.style.display = 'block'
progress.style.height = '20px'
progress.style.whiteSpace = 'nowrap'

function parseFile(file, options) {
    var fileSize = file.size
    var chunkSize = 1024 * 1024
    var offset = 0
    var readBlock = null
    var chunkReadCallback = function(data) {
        // send data to server
    }
    var chunkErrorCallback = function(err) {
        console.log('ERROR', err)
    }
    var success = function(count) {
        console.log('Yes :)))) ' + count)
    }
    var trouble = function(count) {
        console.log('Trouble????? ' + count)
    }
    var onLoadHandler = function(evt) {
        if (evt.target.error == null) {
            offset += evt.loaded
            chunkReadCallback(evt.target.result)
        } else {
            chunkErrorCallback(evt.target.error)
            return
        }
        var percentage = Math.round((offset / fileSize) * 100)
        progress.innerHTML = file.name + ' &nbsp; ' + percentage + '%'
        progress.style.width = percentage + '%'
        if (offset === fileSize) {
            success(offset)
            return
        } else if (offset > fileSize) {
            trouble(offset)
            return
        }

        readBlock(offset, chunkSize, file)
    }

    readBlock = function(_offset, length, _file) {
        var r = new FileReader()
        var blob = _file.slice(_offset, length + _offset);
        r.onload = onLoadHandler
        r.readAsArrayBuffer(blob)
    }

    readBlock(offset, chunkSize, file)
}

window.ondragover = function() { return false }
window.ondrop = function(e) { 
    if (e.dataTransfer.files.length > 0) {
        parseFile(e.dataTransfer.files[0])
        console.log(e.dataTransfer.files[0])
    }
    return false 
}

})()

    </script>
</body>
</html>
